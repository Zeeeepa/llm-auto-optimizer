# Cloud Build Configuration - LLM-Auto-Optimizer
#
# Deploys the unified LLM-Auto-Optimizer service to Cloud Run.
# Trigger: Push to main branch or manual trigger
#
# Required IAM Roles for Cloud Build Service Account:
# - roles/run.admin
# - roles/iam.serviceAccountUser
# - roles/storage.admin
# - roles/secretmanager.secretAccessor
#
# Required Secrets (in Secret Manager):
# - RUVECTOR_API_KEY
#
# Usage:
#   gcloud builds submit --config cloudbuild.yaml \
#     --substitutions=_PLATFORM_ENV=prod,_SERVICE_VERSION=1.0.0

substitutions:
  _REGION: us-central1
  _SERVICE_NAME: llm-auto-optimizer
  _SERVICE_VERSION: '1.0.0'
  _PLATFORM_ENV: prod
  _MIN_INSTANCES: '1'
  _MAX_INSTANCES: '10'
  _CPU: '2'
  _MEMORY: '2Gi'
  _CONCURRENCY: '80'
  _TIMEOUT: '300s'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8

steps:
  # ============================================================================
  # Step 1: Run Tests
  # ============================================================================
  - name: 'node:20-slim'
    id: 'test'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm ci
        npm run test -- --passWithNoTests
        npm run type-check
    waitFor: ['-']

  # ============================================================================
  # Step 2: Build Container Image
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${_SERVICE_VERSION}'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:latest'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '-f'
      - 'deployment/gcp/cloudrun/Dockerfile'
      - '.'
    waitFor: ['test']

  # ============================================================================
  # Step 3: Push Container Image
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push'
    args:
      - 'push'
      - '--all-tags'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}'
    waitFor: ['build']

  # ============================================================================
  # Step 4: Deploy to Cloud Run
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${_SERVICE_VERSION}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--no-allow-unauthenticated'
      - '--service-account'
      - 'llm-auto-optimizer-sa@${PROJECT_ID}.iam.gserviceaccount.com'
      - '--min-instances'
      - '${_MIN_INSTANCES}'
      - '--max-instances'
      - '${_MAX_INSTANCES}'
      - '--cpu'
      - '${_CPU}'
      - '--memory'
      - '${_MEMORY}'
      - '--concurrency'
      - '${_CONCURRENCY}'
      - '--timeout'
      - '${_TIMEOUT}'
      - '--ingress'
      - 'internal'
      - '--set-env-vars'
      - 'SERVICE_NAME=${_SERVICE_NAME},SERVICE_VERSION=${_SERVICE_VERSION},PLATFORM_ENV=${_PLATFORM_ENV},NODE_ENV=production'
      - '--set-secrets'
      - 'RUVECTOR_API_KEY=ruvector-api-key:latest,RUVECTOR_SERVICE_URL=ruvector-service-url:latest,TELEMETRY_ENDPOINT=telemetry-endpoint:latest'
      - '--labels'
      - 'app=llm-auto-optimizer,env=${_PLATFORM_ENV},version=${_SERVICE_VERSION}'
    waitFor: ['push']

  # ============================================================================
  # Step 5: Verify Deployment
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Verifying deployment..."

        # Get service URL
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region ${_REGION} \
          --format 'value(status.url)')

        echo "Service URL: $SERVICE_URL"

        # Get identity token for authenticated request
        TOKEN=$(gcloud auth print-identity-token)

        # Verify health endpoint
        echo "Checking health endpoint..."
        HEALTH_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$SERVICE_URL/health")
        echo "Health response: $HEALTH_RESPONSE"

        # Verify agents endpoint
        echo "Checking agents endpoint..."
        AGENTS_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$SERVICE_URL/agents")
        echo "Agents response: $AGENTS_RESPONSE"

        # Validate response
        if echo "$HEALTH_RESPONSE" | grep -q '"status"'; then
          echo "✓ Deployment verified successfully"
        else
          echo "✗ Deployment verification failed"
          exit 1
        fi
    waitFor: ['deploy']

# Store images in Artifact Registry
images:
  - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${_SERVICE_VERSION}'
  - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:latest'
  - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${SHORT_SHA}'

# Timeout for entire build
timeout: '1800s'
